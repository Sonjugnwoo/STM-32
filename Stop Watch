/* USER CODE BEGIN Header */
/* USER CODE END Header */

/* Private includes ----------------------------------------------------------*/
/* USER CODE BEGIN Includes */
#include <main.h>  // STM32 HAL 라이브러리 메인 헤더 (CubeMX 자동 생성)
/* USER CODE END Includes */

/* Private includes ----------------------------------------------------------*/
/* USER CODE BEGIN Includes */
/* 사용자 추가 헤더 파일 영역 */
/* USER CODE END Includes */

/* Private typedef -----------------------------------------------------------*/
/* USER CODE BEGIN PTD */
/* 사용자 정의 타입(구조체, enum 등) 영역 */
/* USER CODE END PTD */

/* Private define ------------------------------------------------------------*/
/* USER CODE BEGIN PD */
// SET_IF 매크로: 조건이 true면 GPIO_PIN_SET, false면 GPIO_PIN_RESET 반환
#define SET_IF(expr) ((expr)? GPIO_PIN_SET : GPIO_PIN_RESET)
// 6개 LED 모두 토글할 때 사용할 핀 마스크 (GPIOD 포트)
#define all GPIO_PIN_10|GPIO_PIN_11|GPIO_PIN_12|GPIO_PIN_13|GPIO_PIN_14|GPIO_PIN_15
/* USER CODE END PD */

/* Private macro -------------------------------------------------------------*/
/* USER CODE BEGIN PM */
/* 사용자 정의 매크로 함수 영역 */
/* USER CODE END PM */

/* Private variables ---------------------------------------------------------*/
/* 전역 변수 영역 (CubeMX 관리) */
/* USER CODE BEGIN PV */
/* 사용자 전역 변수 영역 */
/* USER CODE END PV */

/* Private function prototypes -----------------------------------------------*/
void SystemClock_Config(void);     // 시스템 클럭 설정 함수 (CubeMX 자동 생성)
static void MX_GPIO_Init(void);    // GPIO 초기화 함수 (CubeMX 자동 생성)
/* USER CODE BEGIN PFP */
/* 사용자 함수 프로토타입 영역 */
/* USER CODE END PFP */

/* Private user code ---------------------------------------------------------*/
/* USER CODE BEGIN 0 */
/* 사용자 정의 함수 영역 */
/* USER CODE END 0 */


// 스위치 핀 배열 (GPIOA 포트)
int SW[4]={GPIO_PIN_0, GPIO_PIN_1,GPIO_PIN_2,GPIO_PIN_3};

// 공통음극 FND 0~9 패턴 배열 (a~g,dp 순서)
unsigned char FND_CA[]={0xC0, 0xF9, 0xA4, 0xB0, 0x99, 0x92, 0x82, 0xF8, 0x80, 0x90};

// FND1 데이터 핀 (GPIOE)
int FND1[8] = {GPIO_PIN_0,GPIO_PIN_1,GPIO_PIN_11,GPIO_PIN_10,GPIO_PIN_15,GPIO_PIN_5,GPIO_PIN_6,GPIO_PIN_12};

// FND2 데이터 핀 (GPIOE)
int FND2[8] = {GPIO_PIN_8,GPIO_PIN_9,GPIO_PIN_3,GPIO_PIN_2,GPIO_PIN_7,GPIO_PIN_13,GPIO_PIN_14,GPIO_PIN_4};

// LED 핀 배열 (GPIOD)
int LED[6] = {GPIO_PIN_10,GPIO_PIN_11,GPIO_PIN_12,GPIO_PIN_13,GPIO_PIN_14,GPIO_PIN_15};

// FND 제어 함수: value(0~9 또는 0xFF=소등)를 no(1:FND1, 2:FND2)에 표시
void FND_control(int value, int no)
{
    int FND[8];
    int fnd_value=FND_CA[value];
    
    // 0xFF 입력 시 모든 세그먼트 소등
    if(value==0xFF) fnd_value=0xFF;
    else fnd_value=FND_CA[value];
    
    // FND 번호에 따라 핀 배열 복사
    if(no==1) memcpy(FND, FND1, sizeof(FND1));
    else memcpy(FND, FND2, sizeof(FND2));
    
    // 각 비트에 따라 GPIO 출력
    for(int z=0;z<8;z++) 
        HAL_GPIO_WritePin(GPIOE, FND[z], SET_IF(fnd_value & (1<<z)));
}
/* USER CODE END 0 */

int main(void)
{
    /* USER CODE BEGIN 1 */
    int cnt=0;           // 카운터 값 (0~99)
    int cnt_function=0;  // 현재 기능 모드 (0:대기, 1:증가, 2:감소, 3:LED 점등, 4:리셋)
    int UP=0;            // 증가/감소 방향 플래그 (1:증가, 0:감소)
    int flag=0;          // 스위치3 토글 플래그
    
    /* MCU 초기화 */
    HAL_Init();
    SystemClock_Config();
    MX_GPIO_Init();
    
    /* USER CODE BEGIN 2 */
    // FND1, FND2 모두 소등 초기화
    FND_control(0xFF,1);
    FND_control(0xFF,2);
    /* USER CODE END 2 */

    /* Infinite loop */
    while (1)
    {
        /* 스위치 입력 읽기 및 모드 설정 */
        if(HAL_GPIO_ReadPin(GPIOA, SW[0]) == 1) cnt_function=1;  // SW0: 증가 모드
        if(HAL_GPIO_ReadPin(GPIOA, SW[1]) == 1) cnt_function=2;  // SW1: 감소 모드
        
        if(HAL_GPIO_ReadPin(GPIOA, SW[2]) ==1)  // SW2: LED 점등 토글
        {
            cnt_function=3;
            if(flag==0) flag=1;  // 토글 플래그 반전
            else flag =0;
        }
        
        if(HAL_GPIO_ReadPin(GPIOA,SW[3])==1) cnt_function=4;  // SW3: 리셋 모드
        
        /* 기능1: 카운터 증가 (SW0) */
        if(cnt_function==1)
        {
            FND_control(cnt % 10, 2);      // 1의 자리 (FND2)
            FND_control(cnt / 10, 1);      // 10의 자리 (FND1)
            HAL_GPIO_TogglePin(GPIOD,all); // 모든 LED 토글
            if(cnt++==99) cnt=0;           // 99→0 순환
            UP=1;                          // 증가 방향 설정
        }
        
        /* 기능2: 카운터 감소 (SW1) */
        if(cnt_function==2)
        {
            FND_control(cnt % 10, 2);
            FND_control(cnt / 10, 1);
            HAL_GPIO_TogglePin(GPIOD,all);
            if(cnt-- == 0) cnt=99;         // 0→99 순환
            UP=0;                          // 감소 방향 설정
        }
        
        /* 기능3: LED 전체 점등 + 이전 방향 유지 (SW2) */
        if(cnt_function==3)
        {
            for(int z=0;z<6;z++) HAL_GPIO_WritePin(GPIOD,LED[z],1);  // 모든 LED 켜기
            if(flag==0)  // 토글에 따라 이전 카운터 모드 복귀
            {
                if(UP==1) cnt_function=1;  // 증가 모드 복귀
                else cnt_function=2;       // 감소 모드 복귀
            }
        }
        
        /* 기능4: 리셋 (SW3) */
        if(cnt_function==4)
        {
            cnt = 0;                           // 카운터 초기화
            for(int z=0;z<6;z++) HAL_GPIO_WritePin(GPIOD,LED[z],0);  // 모든 LED 끄기
            FND_control(cnt%10, 2);            // FND 00 표시
            FND_control(cnt/10, 1);
        }
        
        HAL_Delay(500);  // 500ms 주기 반복
    }
}